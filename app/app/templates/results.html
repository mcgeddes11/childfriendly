{% extends "base.html" %}
{%block content%}
<style>
      /* Always set the map height explicitly to define the size of the div
       * element that contains the map. */
      #map_object {
        height: 100%;
      }
      /* Optional: Makes the sample page fill the window. */
      html, body {
        height: 100%;
        margin: 0;
        padding: 0;
      }

.content h1 {
  font-weight: 300;
  text-align: center;
}

svg {
  width: 300px;
  height: 300px;
  margin: 0 auto;

   text.middle {
    font-weight: 300;
    font-size: 24px;
  }

  .nvd3.nv-pie .nv-pieLabels text {
    font-family: Lato;
    font-size: 24px;
    font-weight: 300;
    fill: #fff !important;
  }
}

.container-fluid {
	width: 80%
}

#legend {
	font-family: Arial, sans-serif;
	background: #fff;
	padding: 10px;
	margin: 10px;
	border: 3px solid #000;
}

#legend h3 {
	margin-top: 0;
}

#legend img {
	vertical-align: middle;
}
</style>

<div class="container-fluid">
	<h1>Results</h1>

		<h3>Your address</h3>
		<div id="address"></div><br>
		<h4>Child's age</h4>
		<div id="age"></div><br>



	<div class="container-fluid" style="width: 100%">
		<div class="row">
  			<div id="map_view" class="col-md-6 col-md-offset-2">
				<div id="map_object"></div>
				<div id="legend"><h3>Legend</h3></div>
			</div>
  			<div id="crime_census_view" class="col-md-2 col-sm-offset-2"></div>
			<div id="school_traffic_view" class="col-md-2 col-sm-offset-2"></div>
		</div>
	</div>
</div>

<script>

  var map;
  var data = {{ data | safe }};
  $("#address").text(data.address)
  $("#age").text(data.age)
  var homePos = {lat: data.lat, lng: data.lon}

	var icons = {
	  crime: {
		name: 'Crime',
		icon: "http://maps.google.com/mapfiles/ms/icons/police.png"
	  },
	  school: {
		name: 'School',
		icon: "http://maps.google.com/mapfiles/ms/icons/homegardenbusiness.png"
	  },
	  census: {
		name: 'Census District',
		icon: "https://maps.gstatic.com/mapfiles/ms2/micons/info_circle.png"
	  },
	  traffic: {
		name: 'Traffic',
		icon: "http://maps.google.com/mapfiles/kml/pal3/icon59.png"
	  }
	};


  function initMap() {
	map = new google.maps.Map(document.getElementById('map_object'), {
	  center: homePos,
	  zoom: 12
	});
	var home_marker = new google.maps.Marker({
		position: homePos,
		map: map
	});

	// Crime
	addItems(data.score_data.crime_raw, map, icons.crime.icon, "Crime");
	// Schools
	addItems(data.score_data.schools_raw, map, icons.school.icon, "School");
	// Census
	addItems(data.score_data.census_raw, map, icons.census.icon, "Census Collection Point");
	// Traffic
	addItems(data.score_data.traffic_raw,  map, icons.traffic.icon, "Traffic Collection Point")

	var legend = document.getElementById('legend');
        for (var key in icons) {
          var type = icons[key];
          var name = type.name;
          var icon = type.icon;
          var div = document.createElement('div');
          div.innerHTML = '<img src="' + icon + '"> ' + name;
          legend.appendChild(div);
        }

        map.controls[google.maps.ControlPosition.LEFT_BOTTOM].push(legend);

  }

  // Function to add records and tooltips to the map
  function addItems(data,map,url,dataType){
	var record, lat, lon, contentString;
	var infoWindow = null;
	// TODO: add tooltips to these with the location name and scaled scores
	for (ii = 0; ii < data.length; ii++){
		record = data[ii]
		lat = record.location.coordinates[1]
		lon = record.location.coordinates[0]
		contentString = getMapPopupContent(record, dataType);
		var marker = new google.maps.Marker({
			position: {lat: lat, lng: lon},
			map: map,
			icon: url
		});
		marker.html = contentString;
		infoWindow = new google.maps.InfoWindow({
          content: "holding..."
        });

		google.maps.event.addListener(marker, 'click', function(){
			infoWindow.setContent(this.html);
			infoWindow.open(map,this)
		});

		//marker.addListener('click', function() {
        //  infoWindow.open(map, marker);
        //});

	}
  }

    // Deal with nulls in individual scores
  	var crime_score = data.score_data.crime_raw.length == 0 ? 0 : data.score_data.crime_score
  	var census_score = data.score_data.census_raw.length == 0 ? 0 : data.score_data.census_score
  	var schools_score = data.score_data.schools_raw.length == 0 ? 0 : data.score_data.schools_score
  	var traffic_score = data.score_data.traffic_raw.length == 0 ? 0 : data.score_data.traffic_score
	// Generate the score plots
	createChart("crime_census_view","crime_score_wheel", "Crime Score", crime_score)
	createChart("crime_census_view","census_score_wheel", "Census Score",census_score)
	createChart("school_traffic_view","school_score_wheel", "School Score",schools_score)
	createChart("school_traffic_view","traffic_score_wheel", "Traffic Score",traffic_score)
	// TODO:  Add comprehensive tooltips to the svgs, explaining the methodology

  // This function creates the score donuts on the rhs
  function createChart(viewName,id, titleString, score){
	// Mapping of scores to text and colors:  -1 -> 0 interval is for null case
	var scoreMap = [{ "min_bound": -1, "max_bound": 0, "color": "#d6d6c2", "desc": "N/A"},
					{ "min_bound": 0, "max_bound":1, "color": "#FF0000", "desc": "Terrible"},
					{ "min_bound": 1, "max_bound":2, "color": "#FF3300", "desc": "Very Bad"},
					{ "min_bound": 2, "max_bound":3, "color": "#ff6600", "desc": "Bad"},
					{ "min_bound": 3, "max_bound":4, "color": "#ff9900", "desc": "Below Average" },
					{ "min_bound": 4, "max_bound":5, "color": "#FFCC00", "desc": "Average"},
					{ "min_bound": 5, "max_bound":6, "color": "#FFFF00", "desc": "Average"},
					{ "min_bound": 6, "max_bound":7, "color": "#ccff00", "desc": "Above Average"},
					{ "min_bound": 7, "max_bound":8, "color": "#66ff00", "desc": "Good"},
					{ "min_bound": 8, "max_bound":9, "color": "#33ff00", "desc": "Great"},
					{ "min_bound": 9, "max_bound":10, "color": "#00FF00", "desc": "Fantastic"}]
	var scoreColor;
	var scoreDesc;
	for (ii=0; ii < scoreMap.length; ii++){
		if (score > scoreMap[ii].min_bound && score <= scoreMap[ii].max_bound){
			scoreColor = scoreMap[ii].color;
			scoreDesc = scoreMap[ii].desc;
		}
	}

	// use first argument to determine which view to add this donut to
	$("#" + viewName).append('<div id="' + id + '"></div>');
	var plotdiv = $("#" + id)
	plotdiv.append("<svg></svg>")



	// Create the donut pie chart and insert it onto the page
	nv.addGraph(function() {
	  var donutChart = nv.models.pieChart()
			.x(function(d) {
			return d.label
		  })
			.y(function(d) {
			return d.value
		  })
			.showLabels(false)
			.showLegend(false)
			.labelThreshold(.05)
			.labelType("key")
			.color([scoreColor,"#d6d6c2"])
			.tooltipContent(
			function(key, y, e, graph) { return 'Custom tooltip string' }
		  ) // This is for when I turn on tooltips
			.tooltips(false)
			.donut(true)
			.donutRatio(0.4);

		// Insert text into the center of the donut
		function centerText() {
			return function() {
				var svg = d3.select("#" + id + " svg");
				var donut = svg.selectAll("g.nv-slice").filter(
					function (d, i) {
					return i == 0;
					}
				);

				// Insert first line of text into middle of donut pie chart
				donut.insert("text", "g")
					.text(score == 0 ? "" : score.toFixed(1))
					.attr("class", "middle")
					.attr("text-anchor", "middle")
						.attr("dy", "-.55em")
						.attr("font-size","16px")
						.attr("fill","#000000")
						.attr("stroke","#000000");
				// Insert second line of text into middle of donut pie chart
				donut.insert("text", "g")
					.text(scoreDesc)
					.attr("class", "middle")
					.attr("text-anchor", "middle")
						.attr("dy", ".85em")
						.attr("font-size","12px")
						.attr("fill","#000000")
						.attr("stroke","#000000");
			}
		}

	  // Put the donut pie chart together
	  d3.select("#" + id + " svg")
		.datum(scaleData(score))
		.transition().duration(300)
		.call(donutChart)
		.call(centerText());

	  return donutChart;
	});


	// Scale this score as data to populate donut pie chart
	function scaleData(score) {
	  return [
		{
		  "label": "good",
		  "value": score
		},
		{
		  "label": "bad",
		  "value": 10 - score
		}
	  ];
	}
	// Add titles
	d3.select("#" + id + " svg")
	  .append("text")
	  .attr("x", 150)
	  .attr("y", 30)
	  .attr("text-anchor", "middle")
	  .attr("font-weight",600)
	  .attr("font-size","20px")
	  .text(titleString);

	}

	function getMapPopupContent(record, dataType){
		var contentString = '<div id="content">'+
						'<div id="siteNotice">'+
						'</div>'+
						'<h3 id="firstHeading" class="firstHeading">' + dataType + '</h3>'+
						'<div id="bodyContent">'+
						'<p>BODY_CONTENT</p>'+
						'</div>'+
						'</div>';
		var details;
		if (dataType.startsWith("Crime")){

			details = '<p><b>' + record["town_name"] + ', ' + record["province_name"] + '</b></p><b>CSI: ' + record["csi"].toString() +'</b>' +
					  '<p>The Crime Severity Index (CSI) tracks changes in the severity of police-reported crime by accounting for both the amount ' +
					  'of crime reported by police in a given jurisdiction and the relative seriousness of these crimes. It tells us not only how much crime ' +
					  'is coming to the attention of police, but also about the seriousness of that crime.</p>' +
					  '<p>More information:  <a href="http://www.statcan.gc.ca/pub/85-004-x/85-004-x2009001-eng.htm?contentType=application%2Fpdf">'+
            		  'here</a></p>'
		} else if (dataType.startsWith("School")){
			details = '<p><b>' + record["school_name"] + '</b></p><b>Rating: ' + record["score"].toString() +'</b>' +
					  '<p>School performance ratings were sourced from  a study undertaken by The Fraser Institute.  They use a 0 to 10 scale, with 10 being the highest performing.' +
					  '</p>' +
					  '<p>More information:  <a href="https://www.fraserinstitute.org/school-performance">'+
            		  'here</a></p>'
		} else if (dataType.startsWith("Census")){
			details = '<p><b>' + record["subdistrict_name"] + ', ' + record["province_name"] + '</b></p>' +
					  '<b>Population: ' + record["total_population"].toString() +'</b>' +
					  '<p>Demographic scores were generated using census data at the subdistrict level. ' +
					  'Scores are computed by comparing the number of children in your childs age bracket relative to provincial averages.</p>' +
					  '<p>More information:  <a href="http://www12.statcan.gc.ca/census-recensement/2016/dp-pd/index-eng.cfm">'+
            		  'here</a></p>'
		} else if (dataType.startsWith("Traffic")){
			details = '<p><b>Route:  ' + record["description"] + '</b></p>' +
					  '<p><b>Site No:  ' + record["site_no"] + '</b></p>' +
					  '<p><b>Traffic count: ' + record["traffic_count"].toString() +'</b></p>' +
					  '<p><b>Traffic ratio: ' + record["traffic_ratio"].toString() +'</b></p>' +
					  '<p>Traffic scores were computed using local traffic data normalized by population size. </p>'
		}
		contentString = contentString.replace("BODY_CONTENT",details)
		return contentString;
	}
</script>
<script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyC1h2PWILmMxZm5ipfiApFUdus_NvsI8WE&callback=initMap" async defer></script>

{%endblock%}
